<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnePost - Social Media Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .placeholder-glow::placeholder {
            color: #9ca3af;
            opacity: 1;
        }
        /* Custom styles for the loader */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app">
        <!-- Login Page -->
        <div id="loginPage" class="flex items-center justify-center min-h-screen animate-fade-in">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-gray-900">OnePost</h1>
                    <p class="mt-2 text-gray-600">Log in to your account</p>
                </div>
                <!-- Error Message -->
                <div id="authError" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                
                <div class="space-y-6">
                    <div>
                        <label for="email" class="sr-only">Email address</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-glow" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-glow" placeholder="Password">
                    </div>
                     <div>
                        <button id="signInButton" type="button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Sign in
                        </button>
                    </div>
                </div>
                 <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">No account?</span>
                    </div>
                </div>
                <div>
                     <button id="signUpButton" type="button" class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Create an Account
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application (Hidden by default) -->
        <div id="mainApp" class="hidden animate-fade-in">
            <div class="flex h-screen bg-gray-100">
                <!-- Sidebar -->
                <div class="w-64 bg-white shadow-md flex flex-col">
                    <div class="p-6 text-2xl font-bold text-gray-900 border-b">OnePost</div>
                    <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                        <a href="#" onclick="showPage('dashboardPage')" data-page="dashboardPage" class="flex items-center px-4 py-2 text-gray-700 bg-gray-200 rounded-lg">
                            <i class="fas fa-tachometer-alt w-6"></i>
                            <span class="ml-3">Dashboard</span>
                        </a>
                        <a href="#" onclick="showPage('newPostPage')" data-page="newPostPage" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg">
                            <i class="fas fa-plus-square w-6"></i>
                            <span class="ml-3">New Post</span>
                        </a>
                        <a href="#" onclick="showPage('connectionsPage')" data-page="connectionsPage" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg">
                             <i class="fas fa-link w-6"></i>
                            <span class="ml-3">Connections</span>
                        </a>
                        <a href="#" onclick="showPage('settingsPage')" data-page="settingsPage" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg">
                            <i class="fas fa-cog w-6"></i>
                            <span class="ml-3">Settings</span>
                        </a>
                    </nav>
                    <div class="p-4 border-t">
                        <div class="flex items-center">
                            <img id="userAvatar" class="h-10 w-10 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=AV" alt="User Avatar">
                            <div class="ml-3">
                                <p id="userName" class="text-sm font-medium text-gray-900">User</p>
                                <p id="userEmail" class="text-xs text-gray-500">user@example.com</p>
                            </div>
                        </div>
                         <button id="signOutButton" class="w-full mt-4 py-2 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">Log Out</button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50">
                        <div class="container mx-auto px-6 py-8">
                            
                            <!-- Dashboard Page Content -->
                            <div id="dashboardPageContent" class="page-content">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-3xl font-medium text-gray-700">Dashboard</h3>
                                    <button onclick="showPage('newPostPage')" class="px-6 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center">
                                        <i class="fas fa-plus mr-2"></i>
                                        Schedule New Post
                                    </button>
                                </div>
                                <div class="mt-8">
                                    <h4 class="text-xl font-medium text-gray-700">Scheduled Posts</h4>
                                    <div id="post-list" class="mt-4 bg-white p-6 rounded-2xl shadow-lg">
                                        <!-- Posts will be dynamically inserted here -->
                                        <div id="no-posts-message" class="text-center text-gray-400 py-8">
                                            You have no posts scheduled. Click "Schedule New Post" to get started!
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- New Post Page Content -->
                            <div id="newPostPageContent" class="page-content hidden">
                                <h3 class="text-3xl font-medium text-gray-700">Create New Post</h3>
                                <div class="mt-8 bg-white p-8 rounded-2xl shadow-lg">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <!-- Left Side - Uploads -->
                                        <div class="space-y-6">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Video File</label>
                                                <div id="video-dropzone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                    <div class="space-y-1 text-center">
                                                        <i class="fas fa-video mx-auto h-12 w-12 text-gray-400"></i>
                                                        <div class="flex text-sm text-gray-600">
                                                            <label for="video-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                                                <span>Upload a file</span>
                                                                <input id="video-upload" name="video-upload" type="file" class="sr-only">
                                                            </label>
                                                            <p class="pl-1">or drag and drop</p>
                                                        </div>
                                                        <p class="text-xs text-gray-500">MP4, MOV up to 1GB</p>
                                                    </div>
                                                </div>
                                                <div id="video-upload-name" class="hidden mt-2 text-sm text-gray-600 flex items-center justify-between">
                                                    <span id="video-filename-text"></span>
                                                    <button id="remove-video" class="text-red-500 hover:text-red-700 text-xs">&times;</button>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Thumbnail</label>
                                                 <div id="thumbnail-dropzone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                    <div class="space-y-1 text-center">
                                                        <i class="fas fa-image mx-auto h-12 w-12 text-gray-400"></i>
                                                        <div class="flex text-sm text-gray-600">
                                                            <label for="thumbnail-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                                                <span>Upload an image</span>
                                                                <input id="thumbnail-upload" name="thumbnail-upload" type="file" class="sr-only" accept="image/png, image/jpeg">
                                                            </label>
                                                            <p class="pl-1">or drag and drop</p>
                                                        </div>
                                                        <p class="text-xs text-gray-500">JPG, PNG up to 10MB</p>
                                                    </div>
                                                </div>
                                                <img id="thumbnail-preview" class="hidden mt-2 rounded-lg w-full object-cover"/>
                                            </div>
                                        </div>

                                        <!-- Right Side - Details -->
                                        <div class="space-y-6">
                                             <div>
                                                <label for="post-title" class="block text-sm font-medium text-gray-700">Title</label>
                                                <input type="text" name="post-title" id="post-title" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="My Awesome Upcoming Video">
                                            </div>
                                            <div>
                                                <label for="post-description" class="block text-sm font-medium text-gray-700">Description</label>
                                                <textarea id="post-description" name="post-description" rows="8" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Tell everyone about your video..."></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Platforms</label>
                                                <div class="mt-2 space-y-2">
                                                    <div class="flex items-center">
                                                        <input id="platform-youtube" name="platforms" type="checkbox" value="youtube" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                        <label for="platform-youtube" class="ml-3 flex items-center text-sm font-medium text-gray-700"><i class="fab fa-youtube text-red-600 text-xl mr-2"></i>YouTube</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input id="platform-facebook" name="platforms" type="checkbox" value="facebook" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                        <label for="platform-facebook" class="ml-3 flex items-center text-sm font-medium text-gray-700"><i class="fab fa-facebook text-blue-600 text-xl mr-2"></i>Facebook</label>
                                                    </div>
                                                </div>
                                            </div>
                                             <div>
                                                <label for="schedule-time" class="block text-sm font-medium text-gray-700">Schedule Date & Time (Optional)</label>
                                                <input type="datetime-local" name="schedule-time" id="schedule-time" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-8 flex justify-end space-x-4">
                                        <button onclick="showPage('dashboardPage')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button id="schedulePostButton" class="px-6 py-2 border border-transparent rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 flex items-center">
                                            <span id="scheduleButtonText">Schedule Post</span>
                                            <div id="scheduleButtonLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 ml-2"></div>
                                        </button>
                                        <button id="postNowButton" class="px-8 py-2 border border-transparent rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 flex items-center">
                                            <span id="postNowButtonText">Post Now</span>
                                            <div id="postNowButtonLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 ml-2"></div>
                                        </button>
                                    </div>
                                    <div id="formError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm text-right"></div>
                                </div>
                            </div>

                            <!-- Connections Page Content -->
                            <div id="connectionsPageContent" class="page-content hidden">
                                <h3 class="text-3xl font-medium text-gray-700">Connections</h3>
                                <p class="mt-2 text-gray-600">Connect your social media accounts to start posting.</p>
                                <div class="mt-8 space-y-6">
                                    <!-- YouTube Connection -->
                                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fab fa-youtube text-red-600 text-4xl"></i>
                                            <div class="ml-4">
                                                <h4 class="text-lg font-semibold">YouTube</h4>
                                                <p id="youtube-status" class="text-sm text-gray-500">Not Connected</p>
                                            </div>
                                        </div>
                                        <button id="connect-youtube-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Connect</button>
                                    </div>
                                    <!-- Facebook Connection -->
                                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fab fa-facebook text-blue-600 text-4xl"></i>
                                            <div class="ml-4">
                                                <h4 class="text-lg font-semibold">Facebook</h4>
                                                <p id="facebook-status" class="text-sm text-gray-500">Not Connected</p>
                                            </div>
                                        </div>
                                        <button id="connect-facebook-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Connect</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Page Content -->
                             <div id="settingsPageContent" class="page-content hidden">
                                <h3 class="text-3xl font-medium text-gray-700">Settings</h3>
                                <div class="mt-8 bg-white p-8 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800">Firebase Configuration Fix</h4>
                                    <p class="mt-2 text-gray-600">If you see an "unauthorized-domain" error when connecting accounts, you must authorize the domain where this app is running.</p>
                                    
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700">Your App's Current Domain:</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <input type="text" id="authorizedDomain" readonly class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 bg-gray-100 text-gray-600 focus:outline-none">
                                            <button id="copyDomainButton" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-sm font-medium text-gray-700 hover:bg-gray-100">
                                                <i class="fas fa-copy mr-2"></i>
                                                Copy
                                            </button>
                                        </div>
                                         <div id="copy-success" class="hidden mt-2 text-sm text-green-600">Domain copied to clipboard!</div>
                                    </div>

                                    <div class="mt-8 border-t pt-6">
                                        <h5 class="text-lg font-medium text-gray-800">Instructions:</h5>
                                        <ol class="list-decimal list-inside mt-2 space-y-2 text-gray-600">
                                            <li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Firebase Console</a> and select your project (`socialmanage-1e7eb`).</li>
                                            <li>From the side menu, go to **Authentication**.</li>
                                            <li>Click on the **Settings** tab.</li>
                                            <li>Under the "Authorized domains" section, click **Add domain**.</li>
                                            <li>Paste the domain you copied above into the box and click **Add**.</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="mt-8 bg-white p-8 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800">Google Verification Status</h4>
                                    <p class="mt-2 text-gray-600">When connecting your YouTube account, you may see a screen that says "Google hasn't verified this app." This is normal for new applications.</p>

                                    <div class="mt-6">
                                        <h5 class="text-lg font-medium text-gray-800">For Testing (Immediate Fix):</h5>
                                        <p class="mt-1 text-gray-600">You can safely bypass this warning for your own account to continue testing.</p>
                                        <ol class="list-decimal list-inside mt-2 space-y-2 text-gray-600">
                                            <li>On the warning screen, click **"Advanced"**.</li>
                                            <li>Click on **"Go to OnePost (unsafe)"**.</li>
                                            <li>Grant the permissions to connect your account.</li>
                                        </ol>
                                    </div>
                                    
                                    <div class="mt-8 border-t pt-6">
                                        <h5 class="text-lg font-medium text-gray-800">For Production (Public App):</h5>
                                        <p class="mt-1 text-gray-600">To remove this warning for all users, you must submit your app to Google for verification. This involves setting up your OAuth consent screen.</p>
                                        <ol class="list-decimal list-inside mt-2 space-y-2 text-gray-600">
                                            <li>Go to the <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console API & Services</a> page.</li>
                                            <li>Select your project (`socialmanage-1e7eb`).</li>
                                            <li>Configure the **OAuth consent screen** with your application's name, logo, privacy policy URL, and terms of service URL.</li>
                                            <li>Once configured, you can submit the app for verification.</li>
                                        </ol>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            GoogleAuthProvider,
            FacebookAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            doc,
            deleteDoc,
            setDoc,
            getDoc,
            serverTimestamp,
            enableNetwork
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

        // User's web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNop2oEG3_E9s66WB8x_gxeZch_RcfmWA",
            authDomain: "socialmanage-1e7eb.firebaseapp.com",
            projectId: "socialmanage-1e7eb",
            storageBucket: "socialmanage-1e7eb.appspot.com",
            messagingSenderId: "318738722373",
            appId: "1:318738722373:web:be74b982db387885317d2c",
            measurementId: "G-ZK572FDF83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Try to enable the network to fix "client is offline" errors
        try {
            enableNetwork(db);
        } catch (error) {
            console.error("Could not enable network:", error);
        }

        // --- Global State ---
        let videoFile = null;
        let thumbnailFile = null;
        let currentUser = null;

        // --- DOM Elements ---
        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const authError = document.getElementById('authError');
        const signInButton = document.getElementById('signInButton');
        const signUpButton = document.getElementById('signUpButton');
        const signOutButton = document.getElementById('signOutButton');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        
        const schedulePostButton = document.getElementById('schedulePostButton');
        const postNowButton = document.getElementById('postNowButton');

        const formError = document.getElementById('formError');
        const postList = document.getElementById('post-list');
        const noPostsMessage = document.getElementById('no-posts-message');

        const videoUploadInput = document.getElementById('video-upload');
        const thumbnailUploadInput = document.getElementById('thumbnail-upload');
        const videoUploadName = document.getElementById('video-upload-name');
        const videoFilenameText = document.getElementById('video-filename-text');
        const removeVideoButton = document.getElementById('remove-video');
        const thumbnailPreview = document.getElementById('thumbnail-preview');
        const videoDropzone = document.getElementById('video-dropzone');
        const thumbnailDropzone = document.getElementById('thumbnail-dropzone');

        const connectYoutubeBtn = document.getElementById('connect-youtube-btn');
        const connectFacebookBtn = document.getElementById('connect-facebook-btn');
        const youtubeStatusEl = document.getElementById('youtube-status');
        const facebookStatusEl = document.getElementById('facebook-status');
        const authorizedDomainInput = document.getElementById('authorizedDomain');
        const copyDomainButton = document.getElementById('copyDomainButton');
        const copySuccessMessage = document.getElementById('copy-success');


        // --- UI Interactivity ---
        window.showPage = (pageId) => {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId + 'Content').classList.remove('hidden');

            document.querySelectorAll('#sidebarNav a').forEach(link => {
                link.classList.remove('bg-gray-200');
                if (link.dataset.page === pageId) {
                    link.classList.add('bg-gray-200');
                }
            });
             if (pageId === 'newPostPage') {
                resetForm();
            }
             if (pageId === 'connectionsPage') {
                checkConnectionStatus();
            }
             if (pageId === 'settingsPage') {
                updateSettingsPage();
            }
        };
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                loginPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userNameEl.textContent = user.displayName || 'User';
                userEmailEl.textContent = user.email;
                listenToPosts(user.uid);
                checkConnectionStatus();
            } else {
                loginPage.classList.remove('hidden');
                mainApp.classList.add('hidden');
                postList.innerHTML = ''; 
                postList.appendChild(noPostsMessage);
            }
        });

        const displayAuthError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
        };
        
        const displayFormError = (message) => {
            formError.textContent = message;
            formError.classList.remove('hidden');
        }

        signInButton.addEventListener('click', async () => {
            authError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } 
            catch (error) { displayAuthError(error.message); }
        });

        signUpButton.addEventListener('click', async () => {
             authError.classList.add('hidden');
             try { await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } 
             catch (error) { displayAuthError(error.message); }
        });

        signOutButton.addEventListener('click', async () => {
            try { await signOut(auth); } catch (error) { console.error("Sign out error", error); }
        });
        
        // --- Firestore Database ---
        const listenToPosts = (userId) => {
            const q = query(collection(db, "posts"), where("ownerId", "==", userId));
            onSnapshot(q, (snapshot) => {
                postList.innerHTML = '';
                if (snapshot.empty) {
                    postList.appendChild(noPostsMessage);
                } else {
                    snapshot.docs.sort((a,b) => b.data().createdAt - a.data().createdAt).forEach(doc => {
                        postList.appendChild(createPostElement(doc.data(), doc.id));
                    });
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                if(error.code === 'unavailable') {
                    alert("Could not connect to the database. Please check your internet connection.");
                }
            });
        };
        
        const createPostElement = (post, id) => {
            const div = document.createElement('div');
            div.className = 'flex items-center p-4 border rounded-lg animate-fade-in';
            div.setAttribute('data-id', id);
            const scheduledDate = post.scheduleTime.toDate();
            const isImmediate = post.postType === 'immediate';
            const statusText = isImmediate ? `Posted on: ${scheduledDate.toLocaleString()}` : `Scheduled for: ${scheduledDate.toLocaleString()}`;
            let platformsHtml = '';
            if (post.platforms.includes('youtube')) platformsHtml += `<i class="fab fa-youtube text-red-600 text-2xl" title="YouTube"></i>`;
            if (post.platforms.includes('facebook')) platformsHtml += `<i class="fab fa-facebook text-blue-600 text-2xl ml-2" title="Facebook"></i>`;
            div.innerHTML = `
                <img class="h-16 w-28 object-cover rounded-md bg-gray-200" src="${post.thumbnailUrl || 'https://placehold.co/400x300/A0AEC0/FFFFFF?text=Thumb'}" alt="Video thumbnail">
                <div class="ml-4 flex-1">
                    <p class="font-bold text-gray-800">${post.title}</p>
                    <p class="text-sm text-gray-500">${statusText}</p>
                </div>
                <div class="flex space-x-2">${platformsHtml}</div>
                <button class="ml-4 text-gray-400 hover:text-red-500 text-xl" onclick="deletePost('${id}')">&times;</button>
            `;
            return div;
        };
        
        window.deletePost = async (id) => {
             if (confirm('Are you sure you want to delete this post?')) {
                try { await deleteDoc(doc(db, "posts", id)); } 
                catch(e) { alert("Error deleting post."); }
             }
        }
        
        const handlePostCreation = async (postType) => {
            if (!currentUser) { displayFormError("You must be logged in."); return; }
            const title = document.getElementById('post-title').value;
            const scheduleTimeString = document.getElementById('schedule-time').value;
            const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(el => el.value);
            let scheduleTime;
            if (postType === 'immediate') {
                scheduleTime = new Date();
            } else {
                if (!scheduleTimeString) { displayFormError("Please select a schedule date and time."); return; }
                scheduleTime = new Date(scheduleTimeString);
            }
            if (!title || platforms.length === 0) { displayFormError("Please fill in Title and select at least one platform."); return; }
            if (!videoFile || !thumbnailFile) { displayFormError("Please upload a video and a thumbnail."); return; }
            
            setLoading(true, postType);
            try {
                const videoUrl = await uploadFile(videoFile, `videos/${currentUser.uid}/${Date.now()}_${videoFile.name}`);
                const thumbnailUrl = await uploadFile(thumbnailFile, `thumbnails/${currentUser.uid}/${Date.now()}_${thumbnailFile.name}`);
                await addDoc(collection(db, "posts"), {
                    ownerId: currentUser.uid,
                    title: title,
                    description: document.getElementById('post-description').value,
                    platforms: platforms,
                    scheduleTime: scheduleTime,
                    postType: postType,
                    videoUrl: videoUrl,
                    thumbnailUrl: thumbnailUrl,
                    createdAt: serverTimestamp()
                });
                showPage('dashboardPage');
            } catch (error) {
                console.error("Error creating post: ", error);
                displayFormError("Failed to create post. " + error.message);
            } finally {
                setLoading(false, postType);
            }
        };
        
        schedulePostButton.addEventListener('click', () => handlePostCreation('scheduled'));
        postNowButton.addEventListener('click', () => handlePostCreation('immediate'));

        // --- OAuth Connections ---
        const connectYouTube = async () => {
            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/youtube.upload');
            provider.addScope('https://www.googleapis.com/auth/youtube');
            try {
                const result = await signInWithPopup(auth, provider);
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;
                
                // Store token securely
                const connectionRef = doc(db, "connections", currentUser.uid);
                await setDoc(connectionRef, { youtubeToken: token, youtubeUsername: result.user.displayName }, { merge: true });
                
                alert("YouTube connected successfully!");
                checkConnectionStatus();
            } catch (error) {
                if (error.code === 'auth/cancelled-popup-request') {
                    console.log("Popup closed by user.");
                } else {
                    console.error("YouTube connection error:", error);
                    alert("Failed to connect YouTube: " + error.message);
                }
            }
        };

        const connectFacebook = async () => {
            const provider = new FacebookAuthProvider();
            provider.addScope('pages_show_list');
            provider.addScope('pages_manage_posts');
            provider.addScope('publish_video');
            try {
                const result = await signInWithPopup(auth, provider);
                const credential = FacebookAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;
                
                // Store token securely
                const connectionRef = doc(db, "connections", currentUser.uid);
                await setDoc(connectionRef, { facebookToken: token, facebookUsername: result.user.displayName }, { merge: true });

                alert("Facebook connected successfully!");
                checkConnectionStatus();
            } catch (error) {
                 if (error.code === 'auth/cancelled-popup-request') {
                    console.log("Popup closed by user.");
                } else {
                    console.error("Facebook connection error:", error);
                    alert("Failed to connect Facebook: " + error.message);
                }
            }
        };

        const disconnect = async (platform) => {
            if (!confirm(`Are you sure you want to disconnect ${platform}?`)) return;
            const connectionRef = doc(db, "connections", currentUser.uid);
            const tokenField = platform === 'YouTube' ? 'youtubeToken' : 'facebookToken';
            const usernameField = platform === 'YouTube' ? 'youtubeUsername' : 'facebookUsername';
            
            await setDoc(connectionRef, { [tokenField]: null, [usernameField]: null }, { merge: true });
            alert(`${platform} disconnected.`);
            checkConnectionStatus();
        }

        const checkConnectionStatus = async () => {
            if (!currentUser) return;
            try {
                const connectionRef = doc(db, "connections", currentUser.uid);
                const docSnap = await getDoc(connectionRef);

                if (docSnap.exists() && docSnap.data().youtubeToken) {
                    youtubeStatusEl.textContent = `Connected as ${docSnap.data().youtubeUsername}`;
                    connectYoutubeBtn.textContent = 'Disconnect';
                    connectYoutubeBtn.onclick = () => disconnect('YouTube');
                    connectYoutubeBtn.classList.replace('bg-red-600', 'bg-gray-400');
                } else {
                    youtubeStatusEl.textContent = 'Not Connected';
                    connectYoutubeBtn.textContent = 'Connect';
                    connectYoutubeBtn.onclick = connectYouTube;
                    connectYoutubeBtn.classList.replace('bg-gray-400', 'bg-red-600');
                }

                if (docSnap.exists() && docSnap.data().facebookToken) {
                    facebookStatusEl.textContent = `Connected as ${docSnap.data().facebookUsername}`;
                    connectFacebookBtn.textContent = 'Disconnect';
                    connectFacebookBtn.onclick = () => disconnect('Facebook');
                    connectFacebookBtn.classList.replace('bg-blue-600', 'bg-gray-400');
                } else {
                    facebookStatusEl.textContent = 'Not Connected';
                    connectFacebookBtn.textContent = 'Connect';
                    connectFacebookBtn.onclick = connectFacebook;
                    connectFacebookBtn.classList.replace('bg-gray-400', 'bg-blue-600');
                }
            } catch (error) {
                console.error("Error checking connection status:", error);
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    // Don't alert, just log. The app will retry when online.
                    console.log("Cannot check connections, client is offline.");
                }
            }
        };

        connectYoutubeBtn.addEventListener('click', connectYouTube);
        connectFacebookBtn.addEventListener('click', connectFacebook);


        // --- File Storage ---
        const uploadFile = (file, path) => {
            return new Promise((resolve, reject) => {
                const storageRef = ref(storage, path);
                const uploadTask = uploadBytesResumable(storageRef, file);
                uploadTask.on('state_changed', 
                    (snapshot) => {}, 
                    (error) => reject(error), 
                    () => getDownloadURL(uploadTask.snapshot.ref).then(resolve).catch(reject)
                );
            });
        };

        // --- Helper Functions ---
        const setLoading = (isLoading, type) => {
            const button = type === 'immediate' ? postNowButton : schedulePostButton;
            const textEl = type === 'immediate' ? document.getElementById('postNowButtonText') : document.getElementById('scheduleButtonText');
            const loaderEl = type === 'immediate' ? document.getElementById('postNowButtonLoader') : document.getElementById('scheduleButtonLoader');
            button.disabled = isLoading;
            textEl.classList.toggle('hidden', isLoading);
            loaderEl.classList.toggle('hidden', !isLoading);
        };
        
        const resetForm = () => {
            document.getElementById('post-title').value = '';
            document.getElementById('post-description').value = '';
            document.getElementById('schedule-time').value = '';
            document.querySelectorAll('input[name="platforms"]').forEach(el => el.checked = false);
            formError.classList.add('hidden');
            videoFile = null;
            thumbnailFile = null;
            videoUploadInput.value = '';
            thumbnailUploadInput.value = '';
            videoDropzone.classList.remove('hidden');
            videoUploadName.classList.add('hidden');
            thumbnailDropzone.classList.remove('hidden');
            thumbnailPreview.classList.add('hidden');
            thumbnailPreview.src = '';
        };

        // --- File Input Handlers ---
        const setupDropzone = (dropzone, input, fileHandler) => {
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-500'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    fileHandler(input.files[0]);
                }
            });
            input.addEventListener('change', () => { if (input.files.length) fileHandler(input.files[0]); });
        };

        setupDropzone(videoDropzone, videoUploadInput, (file) => {
            videoFile = file;
            videoFilenameText.textContent = file.name;
            videoDropzone.classList.add('hidden');
            videoUploadName.classList.remove('hidden');
        });

        setupDropzone(thumbnailDropzone, thumbnailUploadInput, (file) => {
            thumbnailFile = file;
            const reader = new FileReader();
            reader.onload = (e) => { thumbnailPreview.src = e.target.result; };
            reader.readAsDataURL(file);
            thumbnailDropzone.classList.add('hidden');
            thumbnailPreview.classList.remove('hidden');
        });

        removeVideoButton.addEventListener('click', () => {
            videoFile = null;
            videoUploadInput.value = '';
            videoDropzone.classList.remove('hidden');
            videoUploadName.classList.add('hidden');
        });
        
        // --- Settings Page Helpers ---
        const updateSettingsPage = () => {
            authorizedDomainInput.value = window.location.hostname;
        };

        copyDomainButton.addEventListener('click', () => {
            authorizedDomainInput.select();
            document.execCommand('copy');
            copySuccessMessage.classList.remove('hidden');
            setTimeout(() => {
                copySuccessMessage.classList.add('hidden');
            }, 2000);
        });

    </script>
</body>
</html>
